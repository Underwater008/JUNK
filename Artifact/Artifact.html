<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JUNK // Museum of the End</title>
    <style>
        /* --- 1. SETUP & VARIABLES --- */
        @import url('https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Courier+Prime:wght@400;700&family=Inter:wght@300;400;600&display=swap');

        :root {
            /* Palette */
            --bg-dark: #080808;
            --bg-panel: rgba(12, 12, 14, 0.9);
            --text-main: #e8e8e0;
            --text-muted: #a0a09a;

            /* Accents */
            --gold: #d4af37;
            --rust: #8a6a5c;
            --terminal-glow: rgba(212, 175, 55, 0.2);

            /* Typography */
            --font-display: 'Cinzel', serif;
            --font-ui: 'Inter', sans-serif;
            --font-mono: 'Courier Prime', monospace;

            --ease-cinematic: cubic-bezier(0.19, 1, 0.22, 1);
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }

        body {
            background-color: var(--bg-dark);
            color: var(--text-main);
            font-family: var(--font-ui);
            height: 100vh;
            width: 100vw;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        /* --- 2. BACKGROUND LAYERS --- */
        .bg-layer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 0;
            pointer-events: none;
        }

        #bg-image {
            background-image: url('Archive_Hall.png');
            /* Fallback to online image if local file missing */
            background-image: url('Archive_Hall.png'), url('https://images.unsplash.com/photo-1518066000714-58c45f1a2c0a?q=80&w=2000&auto=format&fit=crop');
            background-size: cover;
            background-position: center center;
            opacity: 1;
            filter: brightness(0.65) contrast(1.1) saturation(0.8);
            transform: scale(1.02);
            transition: transform 0.2s ease-out;
        }

        .noise {
            background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.8' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)' opacity='1'/%3E%3C/svg%3E");
            opacity: 0.1; mix-blend-mode: overlay;
        }

        .grime {
            background: radial-gradient(transparent 40%, rgba(0, 0, 0, 0.3) 100%),
                        url("data:image/svg+xml,%3Csvg width='100' height='100' viewBox='0 0 100 100' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='%239C92AC' fill-opacity='0.1'%3E%3Cpath d='M11 18c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm48 25c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7z'/%3E%3C/g%3E%3C/svg%3E");
            opacity: 0.2; mix-blend-mode: multiply; z-index: 1;
        }

        .vignette {
            background: radial-gradient(circle at 50% 55%, transparent 40%, rgba(0,0,0,0.5) 80%, rgba(0,0,0,0.9) 100%);
            z-index: 2;
        }

        /* --- 3. NAVIGATION --- */
        header {
            position: absolute; top: 0; width: 100%; height: 80px;
            display: flex; justify-content: space-between; align-items: center;
            padding: 0 40px; z-index: 100;
            border-bottom: 1px solid rgba(255,255,255,0.08);
            background: linear-gradient(to bottom, rgba(0,0,0,0.8), transparent);
        }

        .logo {
            display: flex; align-items: center;
        }

        .logo img {
            height: 35px;
            width: auto;
            filter: drop-shadow(0 2px 4px rgba(0,0,0,0.8));
            opacity: 0.9;
            transition: opacity 0.3s;
        }
        .logo img:hover { opacity: 1; }

        .nav-links { display: flex; gap: 30px; }
        .nav-item {
            font-family: var(--font-ui); font-size: 0.7rem; color: #ccc;
            text-transform: uppercase; letter-spacing: 2px; text-decoration: none;
            transition: color 0.3s; cursor: pointer; text-shadow: 0 2px 5px rgba(0,0,0,0.8);
        }
        .nav-item:hover, .nav-item.active { color: var(--gold); border-bottom: 1px solid var(--gold); }

        /* --- 4. GALLERY LAYOUT --- */
        main {
            position: relative; flex: 1; display: flex; flex-direction: column;
            justify-content: center; align-items: center; z-index: 10;
            perspective: 1200px;
        }

        .gallery-header {
            text-align: center; margin-bottom: 30px; z-index: 20;
            opacity: 0; animation: fade-in 1.5s forwards 0.5s;
        }

        .gallery-header h1 {
            font-family: var(--font-display); font-size: 3rem; color: var(--text-main);
            letter-spacing: 12px; margin-bottom: 8px;
            text-shadow: 0 4px 30px rgba(0,0,0,1), 0 0 10px rgba(0,0,0,0.5);
        }

        .gallery-header .subline {
            font-family: var(--font-mono); font-size: 0.75rem; color: var(--gold);
            text-transform: uppercase; letter-spacing: 4px; background: rgba(0,0,0,0.6);
            padding: 5px 15px; border: 1px solid rgba(255,255,255,0.1);
            display: inline-block; backdrop-filter: blur(5px);
        }

        /* --- CAROUSEL STACK --- */
        .carousel-stage {
            position: relative; width: 100%; height: 520px;
            display: flex; justify-content: center; align-items: center;
            transform-style: preserve-3d;
        }

        .card {
            position: absolute; width: 320px; height: 480px;
            background: var(--bg-panel); border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 30px 60px rgba(0,0,0,0.8); transition: all 0.7s var(--ease-cinematic);
            cursor: pointer; overflow: hidden; display: flex; flex-direction: column;
            backdrop-filter: blur(10px);
        }

        .card.active {
            z-index: 10; border-color: var(--gold);
            box-shadow: 0 0 30px rgba(0,0,0,0.8), 0 0 15px var(--terminal-glow);
        }
        .card.left, .card.right { z-index: 5; filter: brightness(0.4) blur(2px); opacity: 0.7; }
        .card.hidden { opacity: 0; pointer-events: none; transform: scale(0.5); }

        .card-image {
            width: 100%; height: 60%; background: #000;
            overflow: hidden; position: relative; border-bottom: 1px solid rgba(255,255,255,0.05);
        }
        .card-image img {
            width: 100%; height: 100%; object-fit: cover;
            transition: transform 0.6s; filter: grayscale(80%) contrast(1.1);
        }
        .card.active .card-image img { filter: grayscale(10%) contrast(1.05); }

        .card-info {
            flex: 1; padding: 25px; display: flex; flex-direction: column;
            justify-content: flex-start; opacity: 0; transition: opacity 0.4s;
            background: linear-gradient(to bottom, rgba(20,20,20,0.9), rgba(10,10,10,1));
        }
        .card.active .card-info { opacity: 1; }

        .card-obj-code { font-family: var(--font-mono); font-size: 0.65rem; color: var(--gold); margin-bottom: 5px; opacity: 0.9; }
        .card-title { font-family: var(--font-display); font-size: 1.3rem; color: var(--text-main); margin-bottom: 10px; letter-spacing: 1px; line-height: 1; }
        .card-subtitle {
            font-family: var(--font-ui); font-size: 0.6rem; text-transform: uppercase;
            color: var(--rust); letter-spacing: 2px; margin-bottom: 15px; padding-bottom: 10px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        .card-desc {
            font-family: var(--font-ui); font-size: 0.75rem; color: #a0a09a; line-height: 1.5;
            display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical; overflow: hidden;
        }

        .side-label {
            position: absolute; bottom: 20px; left: 0; width: 100%; text-align: center;
            font-family: var(--font-mono); font-size: 0.8rem; color: var(--text-main);
            opacity: 0; transition: opacity 0.4s; z-index: 30; text-shadow: 0 2px 4px black;
            background: rgba(0,0,0,0.6); padding: 5px 0;
        }
        .card.left .side-label, .card.right .side-label { opacity: 1; }

        /* --- CONTROLS --- */
        .gallery-controls {
            margin-top: 40px; z-index: 20;
            display: flex; flex-direction: column; align-items: center; gap: 20px;
        }
        .nav-buttons { display: flex; gap: 40px; }
        .control-btn {
            background: rgba(0,0,0,0.7); border: 1px solid var(--text-muted);
            color: var(--text-main); font-family: var(--font-mono); font-size: 0.75rem;
            padding: 12px 25px; cursor: pointer; text-transform: uppercase; letter-spacing: 2px;
            transition: all 0.3s; backdrop-filter: blur(4px);
        }
        .control-btn:hover {
            border-color: var(--gold); color: var(--gold);
            box-shadow: 0 0 15px var(--terminal-glow); background: rgba(10, 5, 0, 0.9);
        }
        .index-indicator {
            display: flex; gap: 15px; font-family: var(--font-mono);
            font-size: 0.7rem; color: var(--text-muted); align-items: center;
            background: rgba(0,0,0,0.6); padding: 5px 15px; border-radius: 20px;
            backdrop-filter: blur(4px);
        }
        .dot-group { display: flex; gap: 8px; }
        .dot { width: 4px; height: 4px; background: #666; border-radius: 50%; transition: background 0.3s; }
        .dot.active { background: var(--gold); box-shadow: 0 0 5px var(--gold); }
        .current-name { color: var(--text-main); letter-spacing: 2px; min-width: 150px; text-align: center; text-transform: uppercase; }

        /* --- DETAIL (VITRINE) OVERLAY --- */
        #detail-view {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(5, 5, 5, 0.85); z-index: 200;
            opacity: 0; pointer-events: none; transition: opacity 0.5s var(--ease-cinematic);
            display: flex; align-items: center; justify-content: center; backdrop-filter: blur(15px);
        }
        #detail-view.active { opacity: 1; pointer-events: auto; }

        .vitrine-panel {
            width: 85%; max-width: 1200px; height: 75vh;
            background: #0e0e10; border: 1px solid rgba(255,255,255,0.1);
            display: grid; grid-template-columns: 1.2fr 1fr;
            box-shadow: 0 50px 100px rgba(0,0,0,0.9); position: relative;
        }
        .panel-header {
            position: absolute; top: -45px; left: 0; width: 100%;
            display: flex; justify-content: space-between; align-items: flex-end;
            padding-bottom: 10px; border-bottom: 1px solid rgba(255,255,255,0.15);
        }
        .panel-obj-id {
            font-family: var(--font-mono); color: var(--gold); font-size: 0.9rem; letter-spacing: 2px;
            background: rgba(0,0,0,0.6); padding: 4px 8px;
        }
        .close-btn {
            background: rgba(0,0,0,0.6); border: 1px solid transparent; color: var(--text-muted);
            cursor: pointer; font-family: var(--font-mono); font-size: 0.8rem;
            text-transform: uppercase; letter-spacing: 1px; transition: 0.3s; padding: 5px 10px;
        }
        .close-btn:hover { color: var(--text-main); border-color: var(--text-muted); background: #000; }

        .panel-image-container {
            border-right: 1px solid rgba(255,255,255,0.05);
            background: radial-gradient(circle at 50% 50%, #1a1a1e 0%, #000 100%);
            position: relative; display: flex; justify-content: center; align-items: center; overflow: hidden;
        }
        .panel-image-container img {
            max-width: 85%; max-height: 85%; object-fit: contain;
            filter: drop-shadow(0 30px 60px rgba(0,0,0,0.9));
            transition: opacity 0.3s ease;
        }

        /* IMAGE NAVIGATION BUTTONS */
        .img-nav-btn {
            position: absolute; top: 50%; transform: translateY(-50%);
            background: rgba(0,0,0,0.4); color: var(--text-muted);
            border: 1px solid rgba(255,255,255,0.1);
            width: 40px; height: 60px;
            display: flex; align-items: center; justify-content: center;
            font-family: var(--font-mono); font-size: 1.5rem;
            cursor: pointer; transition: all 0.2s; z-index: 10;
            backdrop-filter: blur(4px);
        }
        .img-nav-btn:hover { background: var(--gold); color: #000; border-color: var(--gold); }
        .img-nav-btn.prev { left: 10px; }
        .img-nav-btn.next { right: 10px; }
        .img-nav-btn.hidden { opacity: 0; pointer-events: none; }

        .img-caption {
            position: absolute; bottom: 20px; left: 20px;
            font-family: var(--font-mono); font-size: 0.6rem; color: var(--text-muted);
            border: 1px solid rgba(255,255,255,0.1); padding: 4px 8px; text-transform: uppercase;
        }
        .panel-data { padding: 60px; display: flex; flex-direction: column; overflow-y: auto; z-index: 2; }
        .panel-title {
            font-family: var(--font-display); font-size: 2.5rem; color: var(--text-main);
            letter-spacing: 6px; margin-bottom: 40px; line-height: 1;
            padding-bottom: 20px; border-bottom: 1px solid var(--gold-dim);
        }
        .meta-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 30px; margin-bottom: 40px; }
        .meta-item label {
            display: block; font-family: var(--font-ui); font-size: 0.6rem;
            color: var(--text-muted); text-transform: uppercase; letter-spacing: 2px; margin-bottom: 6px;
        }
        .meta-item span {
            display: block; font-family: var(--font-mono); font-size: 0.85rem;
            color: var(--gold); border-left: 2px solid var(--rust); padding-left: 10px;
        }
        .panel-description { font-family: var(--font-mono); font-size: 0.9rem; line-height: 1.7; color: #b0b0a0; margin-bottom: 20px; }
        .field-note {
            margin-top: auto; background: rgba(255,255,255,0.03); padding: 15px;
            border-left: 2px solid var(--text-muted); font-family: var(--font-ui);
            font-size: 0.75rem; color: var(--text-muted); font-style: italic;
        }

        /* --- ADMIN PANEL --- */
        #admin-panel {
            position: fixed; bottom: 20px; right: 20px;
            width: 350px; max-height: 85vh; overflow-y: auto;
            background: #000; border: 1px solid #0f0;
            color: #0f0; font-family: 'Courier Prime', monospace;
            padding: 20px; z-index: 1000; box-shadow: 0 0 20px rgba(0, 255, 0, 0.2);
            display: none; font-size: 0.8rem;
        }
        #admin-panel.visible { display: block; animation: boot-term 0.3s; }
        #admin-panel h3 { margin-bottom: 15px; text-transform: uppercase; border-bottom: 1px solid #0f0; padding-bottom: 5px; }
        .admin-row { margin-bottom: 10px; display: flex; flex-direction: column; }
        .admin-row label { font-size: 0.7rem; opacity: 0.7; margin-bottom: 3px; }
        .admin-row input, .admin-row textarea, .admin-row select {
            background: #111; border: 1px solid #333; color: #0f0;
            padding: 5px; font-family: inherit; font-size: 0.8rem;
        }
        .admin-row textarea { height: 50px; resize: vertical; }

        /* History Log Styles */
        #admin-history-log {
            margin-top: 20px;
            border-top: 1px dashed #0f0;
            padding-top: 10px;
            max-height: 150px;
            overflow-y: auto;
        }
        .log-entry { font-size: 0.65rem; margin-bottom: 4px; border-bottom: 1px solid #222; padding-bottom: 2px; }
        .log-time { opacity: 0.5; margin-right: 5px; }
        .log-detail { color: #cfc; }

        @keyframes fade-in { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes boot-term { from { transform: scaleY(0); transform-origin: bottom; } to { transform: scaleY(1); } }
    </style>
</head>
<body>

    <!-- Backgrounds -->
    <div class="bg-layer bg-image" id="bg-image"></div>
    <div class="bg-layer noise"></div>
    <div class="bg-layer grime"></div>
    <div class="bg-layer vignette"></div>

    <!-- Navigation -->
    <header>
        <div class="logo">
            <a href="../index.html"><img src="junk-logo-w.png" alt="JUNK Logo"></a>
        </div>
        <nav class="nav-links">
            <a href="../terrain.html" class="nav-item">Overview</a>
            <a href="Artifact.html" class="nav-item active">Artifacts</a>
            <a href="../INTRO/INTRO.html" class="nav-item">About</a>
        </nav>
    </header>

    <!-- Gallery View -->
    <main id="gallery-view">
        <div class="gallery-header">
            <h1 id="main-title">THE MUSEUM OF KINTANA TELO</h1>
            <div class="subline" id="main-subtitle">Recovered Objects from the Archipelago</div>
        </div>

        <div class="carousel-stage" id="carousel-stage"></div>

        <div class="gallery-controls">
            <div class="index-indicator">
                <span id="current-obj-name" class="current-name">LOADING...</span>
                <div class="dot-group" id="dot-group"></div>
            </div>
            <div class="nav-buttons">
                <button class="control-btn" id="btn-prev">‚Äπ Previous Object</button>
                <button class="control-btn" id="btn-next">Next Object ‚Ä∫</button>
            </div>
        </div>
    </main>

    <!-- Detailed Record View -->
    <section id="detail-view">
        <div class="vitrine-panel">
            <div class="panel-header">
                <div class="panel-obj-id" id="det-id">OBJ-XXX ¬∑ NAME</div>
                <button class="close-btn" id="btn-close">[Close Record]</button>
            </div>
            <div class="panel-image-container">
                <!-- Navigation Buttons for Images -->
                <button class="img-nav-btn prev hidden" id="det-img-prev" title="Previous Image">‚Äπ</button>
                <img src="" id="det-img" alt="Artifact">
                <button class="img-nav-btn next hidden" id="det-img-next" title="Next Image">‚Ä∫</button>

                <div class="img-caption">Archival Image Reconstruction</div>
            </div>
            <div class="panel-data">
                <h2 class="panel-title" id="det-title">Artifact Name</h2>
                <div class="meta-grid">
                    <div class="meta-item"><label>Origin</label><span id="det-origin">...</span></div>
                    <div class="meta-item"><label>Era</label><span id="det-era">...</span></div>
                    <div class="meta-item"><label>Material</label><span id="det-mat">...</span></div>
                    <div class="meta-item"><label>Condition</label><span id="det-cond">...</span></div>
                </div>
                <p class="panel-description" id="det-desc">...</p>
                <div class="field-note" id="det-note">...</div>
            </div>
        </div>
    </section>

    <!-- HIDDEN ADMIN PANEL -->
    <div id="admin-panel">
        <h3>// SYSTEM OVERRIDE</h3>
        <div class="admin-row">
            <label>Select Object ID:</label>
            <select id="admin-select"></select>
        </div>
        <div class="admin-row">
            <label>Name:</label>
            <input type="text" id="admin-name" data-field="name">
        </div>
        <div class="admin-row">
            <label>Image Path (Base):</label>
            <input type="text" id="admin-img" data-field="img">
        </div>
        <div class="admin-row">
            <label>Image Count:</label>
            <input type="number" id="admin-img-count" data-field="imgCount" min="1" value="1">
        </div>

        <!-- Expanded Fields -->
        <div class="admin-row">
            <label>Origin:</label>
            <input type="text" id="admin-origin" data-field="origin">
        </div>
        <div class="admin-row">
            <label>Era:</label>
            <input type="text" id="admin-era" data-field="era">
        </div>
        <div class="admin-row">
            <label>Material:</label>
            <input type="text" id="admin-mat" data-field="material">
        </div>
        <div class="admin-row">
            <label>Condition:</label>
            <input type="text" id="admin-cond" data-field="condition">
        </div>

        <div class="admin-row">
            <label>Description:</label>
            <textarea id="admin-desc" data-field="desc"></textarea>
        </div>
        <div class="admin-row">
            <label>Field Note:</label>
            <textarea id="admin-note" data-field="note"></textarea>
        </div>

        <!-- Manual Save Button -->
        <button id="admin-save-btn" style="
            width: 100%;
            margin-top: 15px;
            padding: 10px;
            background: #0a0;
            border: 1px solid #0f0;
            color: #000;
            font-family: 'Courier Prime', monospace;
            font-size: 0.8rem;
            font-weight: bold;
            text-transform: uppercase;
            cursor: pointer;
            transition: all 0.2s;
        " onmouseover="this.style.background='#0f0'" onmouseout="this.style.background='#0a0'">
            üíæ SAVE CHANGES
        </button>

        <div style="margin-top:10px; font-size:0.6rem; opacity:0.5; text-align:center;">
            Manual save required. Changes saved to cloud.
        </div>

        <!-- HISTORY MODE -->
        <h3 style="margin-top:20px; font-size: 0.7rem; border-color: #333;">// TRANSCRIPT</h3>
        <div id="admin-history-log">
            <!-- Log entries go here -->
        </div>
    </div>

    <script>
        // --- JSONBin Configuration ---
        const JSONBIN_BIN_ID = '693b37ccd0ea881f4022c6b8';
        const JSONBIN_API_KEY = '$2a$10$C8JlCBhv4R5QAmFV/V8O2.rIHdMWNsu7t3ldu.9GUP19YQVrsqE96';
        const JSONBIN_URL = `https://api.jsonbin.io/v3/b/${JSONBIN_BIN_ID}`;

        let lastSaveTime = 0;
        let saveInProgress = false;

        // --- DEFAULT DATA (Updated Paths) ---
        const defaultArtifacts = [
            {
                id: "OBJ-001", name: "Carbonized Fragment", owner: "Ziyi",
                img: "OBJECT_Ziyi.png", imgCount: 1,
                origin: "Crater Edge (Sector 4)", era: "The Collapse", material: "Compressed Carbon, Iron", condition: "Stable / Fragile",
                desc: "A dense, heavy fragment of unknown machinery fused with organic matter. Isotope analysis suggests it was exposed to extreme heat during the primary event.",
                note: "Recovered from the ash layer. Emits a faint hum."
            },
            {
                id: "OBJ-002", name: "Salt Battery", owner: "Steven",
                img: "OBJECT_Steven.png", imgCount: 1,
                origin: "Kitanzi Port", era: "11th Generation", material: "Zinc, Copper, Brine", condition: "Corroded / Leaking",
                desc: "A crude energy storage device manufactured during the resource scarcity period. Uses seawater as a primary electrolyte.",
                note: "Found in a sealed crate marked 'Emergency Power'."
            },
            {
                id: "OBJ-003", name: "Pyrekeeper's Mask", owner: "Yuzie",
                img: "OBJECT_Yuzie.png", imgCount: 1,
                origin: "High Sanctuary", era: "Ritual Era", material: "Ceramic, Ash Glaze", condition: "Intact",
                desc: "Worn by the tenders of the eternal flame. The elongated shape is designed to filter smoke, though it offers no radiation protection.",
                note: "Inscribed with names of the deceased."
            },
            {
                id: "OBJ-004", name: "Dhow Boat Model", owner: "Lilleth",
                img: "OBJECT_Lilleth.png", imgCount: 1,
                origin: "Eastern Archipelago", era: "Pre-Collapse", material: "Teak Wood, Canvas", condition: "Weathered",
                desc: "A hand-carved replica of a traditional transport vessel. These ships were once the lifeline between the scattered islands.",
                note: "Child's toy or navigator's planning tool? Unclear."
            },
            {
                id: "OBJ-005", name: "Sealed Canister", owner: "Jonny",
                img: "OBJECT_Jonny.png", imgCount: 1,
                origin: "Industrial Zone 9", era: "Late Industrial", material: "Polymer, Aluminum", condition: "Sealed / Dented",
                desc: "A hermetically sealed container. The contents are liquid, but scanning attempts have failed due to the lead lining.",
                note: "Do not attempt to open without hazmat protocols."
            },
            {
                id: "OBJ-006", name: "Optical Prism", owner: "Isabel",
                img: "OBJECT_Isabel.png", imgCount: 1,
                origin: "Observatory Ruins", era: "First Light Generation", material: "Glass, Brass", condition: "Chipped",
                desc: "Part of a larger survey instrument. Used to measure land deformation before satellite telemetry was lost.",
                note: "Refracts light in unusual spectra."
            },
            {
                id: "OBJ-007", name: "Amber Cube", owner: "Zhixuan",
                img: "OBJECT_Zhixuan.png", imgCount: 1,
                origin: "The Deep Mines", era: "Unknown", material: "Resin, Gold Flake", condition: "Pristine",
                desc: "A perfect geometric cube of fossilized resin. Suspended inside is a data chip from the Old World.",
                note: "The chip is visible but inaccessible."
            },
            {
                id: "OBJ-008", name: "Signal Flare", owner: "Tiger",
                img: "OBJECT_Tiger.png", imgCount: 1,
                origin: "Coastal Outpost", era: "Reclamation Era", material: "Phosphorus, Cardboard", condition: "Unspent",
                desc: "Standard issue distress signal. The chemical compound has likely degraded, making ignition unstable.",
                note: "Found in a watertight survival kit."
            }
        ];

        // --- STATE & STORAGE ---
        let artifacts = [];
        let historyLog = [];
        let currentIndex = 0;

        // New State for Multi-Image Handling
        let currentDetailImageIndex = 0;

        // Load data from JSONBin
        async function loadData() {
            try {
                const response = await fetch(`${JSONBIN_URL}/latest`, {
                    method: 'GET',
                    headers: {
                        'X-Master-Key': JSONBIN_API_KEY
                    }
                });

                if (!response.ok) {
                    console.warn('Failed to load from JSONBin, using defaults');
                    artifacts = JSON.parse(JSON.stringify(defaultArtifacts));
                    return;
                }

                const result = await response.json();
                const data = result.record;

                if (data && data.artifacts && Array.isArray(data.artifacts) && data.artifacts.length > 0) {
                    artifacts = data.artifacts;
                    // Ensure imgCount exists for legacy data
                    artifacts.forEach(art => {
                        if (typeof art.imgCount === 'undefined') art.imgCount = 1;
                    });
                    console.log('Loaded artifacts from JSONBin:', artifacts.length);
                } else {
                    console.log('Bin is empty, initializing with defaults');
                    artifacts = JSON.parse(JSON.stringify(defaultArtifacts));
                    // Initialize bin with default data
                    await saveDataToJSONBin();
                }

                if (data && data.history && Array.isArray(data.history)) {
                    historyLog = data.history;
                }
            } catch (e) {
                console.error('Error loading from JSONBin:', e);
                artifacts = JSON.parse(JSON.stringify(defaultArtifacts));
            }
        }

        // Save data to JSONBin with merge logic
        async function saveDataToJSONBin() {
            if (saveInProgress) return;
            saveInProgress = true;
            lastSaveTime = Date.now();

            try {
                // Fetch latest data to merge
                let existingData = { artifacts: [], history: [] };
                try {
                    const getResponse = await fetch(`${JSONBIN_URL}/latest`, {
                        method: 'GET',
                        headers: {
                            'X-Master-Key': JSONBIN_API_KEY
                        }
                    });

                    if (getResponse.ok) {
                        const result = await getResponse.json();
                        existingData = result.record || existingData;
                    }
                } catch (e) {
                    console.warn('Could not fetch existing data for merge:', e);
                }

                // Merge artifacts and history
                const dataToSave = {
                    artifacts: artifacts,
                    history: historyLog,
                    lastModified: new Date().toISOString()
                };

                console.log('Attempting to save to JSONBin...', dataToSave);

                const response = await fetch(JSONBIN_URL, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Master-Key': JSONBIN_API_KEY
                    },
                    body: JSON.stringify(dataToSave)
                });

                console.log('JSONBin response status:', response.status);

                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('Failed to save to JSONBin:', response.status, errorText);
                    showSaveNotification(false, `Error ${response.status}`);
                } else {
                    const saveResult = await response.json();
                    console.log('Saved to JSONBin successfully:', saveResult);
                    showSaveNotification(true);
                }
            } catch (error) {
                console.error('Error saving to JSONBin:', error);
                console.error('Error details:', error.message, error.stack);
                showSaveNotification(false, `Error: ${error.message}`);
            } finally {
                saveInProgress = false;
            }
        }

        // Legacy saveData function - now calls JSONBin
        function saveData() {
            saveDataToJSONBin();
            updateGallery();
            if(document.getElementById('detail-view').classList.contains('active')) {
                openRecord(currentIndex);
            }
        }

        // Save history with JSONBin sync
        function saveHistory(msg) {
            const time = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', second: '2-digit' });
            historyLog.unshift({ time: time, msg: msg });
            if(historyLog.length > 50) historyLog.pop(); // keep limit
            renderHistory();
            saveDataToJSONBin(); // Sync to cloud
        }

        // Show save notification
        function showSaveNotification(success, errorMsg = '') {
            let notification = document.getElementById('save-notification');
            if (!notification) {
                notification = document.createElement('div');
                notification.id = 'save-notification';
                notification.style.cssText = `
                    position: fixed;
                    bottom: 30px;
                    right: 30px;
                    background: rgba(0, 0, 0, 0.9);
                    color: #0f0;
                    padding: 12px 20px;
                    border-radius: 4px;
                    font-family: 'Courier Prime', monospace;
                    font-size: 0.75rem;
                    z-index: 10000;
                    opacity: 0;
                    transition: opacity 0.3s;
                    max-width: 400px;
                    word-wrap: break-word;
                `;
                document.body.appendChild(notification);
            }

            if (success) {
                notification.textContent = '‚úì Saved to cloud';
                notification.style.color = '#0f0';
            } else {
                notification.textContent = errorMsg || '‚úó Save failed - Check console (F12)';
                notification.style.color = '#f00';
            }
            notification.style.opacity = '1';

            setTimeout(() => {
                notification.style.opacity = '0';
            }, 3000);
        }

        // Auto-sync: Poll for updates every 5 seconds
        function startAutoSync() {
            setInterval(async () => {
                // Skip if we just saved (avoid overwriting our own changes)
                if (Date.now() - lastSaveTime < 10000) {
                    return;
                }

                try {
                    const response = await fetch(`${JSONBIN_URL}/latest`, {
                        method: 'GET',
                        headers: {
                            'X-Master-Key': JSONBIN_API_KEY
                        }
                    });

                    if (!response.ok) return;

                    const result = await response.json();
                    const data = result.record;

                    if (data && data.artifacts) {
                        // Check if data has changed
                        const currentData = JSON.stringify(artifacts);
                        const newData = JSON.stringify(data.artifacts);

                        if (currentData !== newData) {
                            console.log('Auto-sync: Updating with new data from cloud');
                            artifacts = data.artifacts;
                            // Ensure defaults
                            artifacts.forEach(art => {
                                if (typeof art.imgCount === 'undefined') art.imgCount = 1;
                            });

                            if (data.history) {
                                historyLog = data.history;
                            }
                            updateGallery();
                            renderHistory();
                        }
                    }
                } catch (e) {
                    // Silently fail - don't spam console
                }
            }, 5000); // Check every 5 seconds
        }

        function renderHistory() {
            const container = document.getElementById('admin-history-log');
            container.innerHTML = historyLog.map(entry => `
                <div class="log-entry">
                    <span class="log-time">[${entry.time}]</span>
                    <span class="log-detail">${entry.msg}</span>
                </div>
            `).join('');
        }

        // --- DOM ELEMENTS ---
        const stage = document.getElementById('carousel-stage');
        const dotsContainer = document.getElementById('dot-group');
        const nameDisplay = document.getElementById('current-obj-name');
        const modal = document.getElementById('detail-view');
        const bgImage = document.getElementById('bg-image');

        // --- INIT ---
        async function init() {
            await loadData();
            renderCards();
            updateGallery();
            setupAdmin();
            renderHistory();
            startAutoSync(); // Start polling for updates
        }

        function renderCards() {
            stage.innerHTML = '';
            dotsContainer.innerHTML = '';

            artifacts.forEach((art, index) => {
                const card = document.createElement('div');
                card.className = 'card';
                card.id = `card-${index}`;
                card.onclick = () => handleCardClick(index);
                card.innerHTML = `
                    <div class="card-image"><img src="${art.img}" loading="lazy" onerror="this.src='https://images.unsplash.com/photo-1550625655-b46187b5a5c6?w=600&fit=crop'"></div>
                    <div class="card-info">
                        <div class="card-obj-code">${art.id}</div>
                        <div class="card-title">${art.name}</div>
                        <div class="card-subtitle">ORIGIN: ${art.origin}</div>
                        <div class="card-desc">${art.desc}</div>
                    </div>
                    <div class="side-label">${art.id} // ${art.owner}</div>
                `;
                stage.appendChild(card);

                const dot = document.createElement('div');
                dot.className = 'dot';
                dotsContainer.appendChild(dot);
            });
        }

        // --- GALLERY LOGIC ---
        function updateGallery() {
            const cards = document.querySelectorAll('.card');
            const dots = document.querySelectorAll('.dot');

            cards.forEach((card, i) => {
                const art = artifacts[i];
                card.querySelector('.card-title').innerText = art.name;
                card.querySelector('.card-image img').src = art.img;
                card.querySelector('.card-desc').innerText = art.desc;
                card.querySelector('.card-subtitle').innerText = `ORIGIN: ${art.origin}`;

                // Position Logic
                card.className = 'card';
                const diff = i - currentIndex;

                if (diff === 0) {
                    card.classList.add('active');
                    card.style.transform = 'translateX(0) scale(1.1) translateZ(100px)';
                    card.style.opacity = '1';
                } else if (diff === -1 || (currentIndex === 0 && i === artifacts.length -1)) {
                    card.classList.add('left');
                    card.style.transform = 'translateX(-360px) scale(0.9) translateZ(0)';
                    card.style.opacity = '0.7';
                } else if (diff === 1 || (currentIndex === artifacts.length -1 && i === 0)) {
                    card.classList.add('right');
                    card.style.transform = 'translateX(360px) scale(0.9) translateZ(0)';
                    card.style.opacity = '0.7';
                } else if (diff < 0) {
                    card.classList.add('hidden');
                    card.style.transform = 'translateX(-650px) scale(0.5)';
                } else {
                    card.classList.add('hidden');
                    card.style.transform = 'translateX(650px) scale(0.5)';
                }
            });

            dots.forEach((d, i) => d.classList.toggle('active', i === currentIndex));
            nameDisplay.innerText = `OBJECT ${artifacts[currentIndex].owner}`;

            const adminSelect = document.getElementById('admin-select');
            if(adminSelect && document.getElementById('admin-panel').classList.contains('visible')) {
                adminSelect.value = currentIndex;
                fillAdminInputs();
            }
        }

        function handleCardClick(index) {
            if (index === currentIndex) openRecord(index);
            else { currentIndex = index; updateGallery(); }
        }

        function nextObj() {
            if (currentIndex < artifacts.length - 1) currentIndex++; else currentIndex = 0;
            updateGallery();
        }

        function prevObj() {
            if (currentIndex > 0) currentIndex--; else currentIndex = artifacts.length - 1;
            updateGallery();
        }

        // --- DETAIL RECORD VIEW (With Multi-Image Support) ---

        function getDetailImageUrl(basePath, index) {
            if (index === 0) return basePath;

            // Logic: image.png -> image_1.png
            const dotIndex = basePath.lastIndexOf('.');
            if (dotIndex === -1) return basePath; // Fail safe

            const name = basePath.substring(0, dotIndex);
            const ext = basePath.substring(dotIndex);

            return `${name}_${index}${ext}`;
        }

        function updateDetailImage() {
            const data = artifacts[currentIndex];
            const imgEl = document.getElementById('det-img');
            const nextBtn = document.getElementById('det-img-next');
            const prevBtn = document.getElementById('det-img-prev');

            // Fade out slightly
            imgEl.style.opacity = '0.5';

            setTimeout(() => {
                imgEl.src = getDetailImageUrl(data.img, currentDetailImageIndex);
                imgEl.onload = () => imgEl.style.opacity = '1';
                // Fallback handled by onerror below
            }, 100);

            // Handle Button Visibility
            if (data.imgCount && data.imgCount > 1) {
                prevBtn.classList.remove('hidden');
                nextBtn.classList.remove('hidden');
            } else {
                prevBtn.classList.add('hidden');
                nextBtn.classList.add('hidden');
            }
        }

        function nextDetailImg() {
            const data = artifacts[currentIndex];
            const max = (data.imgCount || 1) - 1;
            if (currentDetailImageIndex < max) {
                currentDetailImageIndex++;
            } else {
                currentDetailImageIndex = 0; // Loop back to start
            }
            updateDetailImage();
        }

        function prevDetailImg() {
            const data = artifacts[currentIndex];
            const max = (data.imgCount || 1) - 1;
            if (currentDetailImageIndex > 0) {
                currentDetailImageIndex--;
            } else {
                currentDetailImageIndex = max; // Loop to end
            }
            updateDetailImage();
        }

        function openRecord(index) {
            const data = artifacts[index];
            currentDetailImageIndex = 0; // Reset to primary image

            document.getElementById('det-id').innerText = `${data.id} ¬∑ ${data.name.toUpperCase()}`;

            // Setup Image with Fallback
            const imgEl = document.getElementById('det-img');
            imgEl.src = data.img;
            imgEl.onerror = function() {
                // Only replace with placeholder if it's the base image or we want generic placeholders
                if(currentDetailImageIndex === 0) {
                    this.src = 'https://images.unsplash.com/photo-1550625655-b46187b5a5c6?w=600&fit=crop';
                }
            };
            imgEl.style.opacity = '1';

            // Setup Buttons
            const nextBtn = document.getElementById('det-img-next');
            const prevBtn = document.getElementById('det-img-prev');

            if (data.imgCount && data.imgCount > 1) {
                prevBtn.classList.remove('hidden');
                nextBtn.classList.remove('hidden');
            } else {
                prevBtn.classList.add('hidden');
                nextBtn.classList.add('hidden');
            }

            document.getElementById('det-title').innerText = data.name;
            document.getElementById('det-origin').innerText = data.origin;
            document.getElementById('det-era').innerText = data.era;
            document.getElementById('det-mat').innerText = data.material;
            document.getElementById('det-cond').innerText = data.condition;
            document.getElementById('det-desc').innerText = data.desc;
            document.getElementById('det-note').innerText = `FIELD NOTE: ${data.note}`;
            modal.classList.add('active');
        }

        document.getElementById('btn-next').addEventListener('click', nextObj);
        document.getElementById('btn-prev').addEventListener('click', prevObj);
        document.getElementById('btn-close').addEventListener('click', () => modal.classList.remove('active'));

        // Image Nav Listeners
        document.getElementById('det-img-next').addEventListener('click', nextDetailImg);
        document.getElementById('det-img-prev').addEventListener('click', prevDetailImg);

        document.addEventListener('keydown', (e) => {
            // ADMIN TOGGLE: Ctrl + Shift + X
            if (e.ctrlKey && e.shiftKey && e.key === 'X') {
                document.getElementById('admin-panel').classList.toggle('visible');
                fillAdminInputs(); // Refresh inputs when opening
            }

            if (modal.classList.contains('active')) {
                if (e.key === 'Escape') modal.classList.remove('active');
                // Enable arrow keys for inner image nav if modal is open
                if (e.key === 'ArrowRight') nextDetailImg();
                if (e.key === 'ArrowLeft') prevDetailImg();
                return;
            }

            // Gallery Nav
            if (e.key === 'ArrowRight') nextObj();
            if (e.key === 'ArrowLeft') prevObj();
            if (e.key === 'Enter') openRecord(currentIndex);
        });

        document.addEventListener('mousemove', (e) => {
            const moveX = (e.clientX - window.innerWidth / 2) * 0.005;
            const moveY = (e.clientY - window.innerHeight / 2) * 0.005;
            bgImage.style.transform = `scale(1.02) translate(${moveX}px, ${moveY}px)`;
        });

        // --- ADMIN SYSTEM ---
        function setupAdmin() {
            const select = document.getElementById('admin-select');

            // Input Elements
            const inputs = {
                name: document.getElementById('admin-name'),
                img: document.getElementById('admin-img'),
                imgCount: document.getElementById('admin-img-count'), // New
                origin: document.getElementById('admin-origin'),
                era: document.getElementById('admin-era'),
                material: document.getElementById('admin-mat'),
                condition: document.getElementById('admin-cond'),
                desc: document.getElementById('admin-desc'),
                note: document.getElementById('admin-note')
            };

            // Populate Select
            artifacts.forEach((art, i) => {
                const opt = document.createElement('option');
                opt.value = i;
                opt.innerText = `${art.id} - ${art.owner}`;
                select.appendChild(opt);
            });

            // Listeners
            select.addEventListener('change', (e) => {
                currentIndex = parseInt(e.target.value);
                updateGallery();
                fillAdminInputs();
            });

            // Track unsaved changes
            let hasUnsavedChanges = false;

            // Bind inputs to update data (without auto-save)
            Object.keys(inputs).forEach(key => {
                const input = inputs[key];

                // Update artifact data on input (local only)
                input.addEventListener('input', () => {
                    const i = parseInt(select.value);
                    if(key === 'mat') artifacts[i].material = input.value;
                    else if(key === 'cond') artifacts[i].condition = input.value;
                    else if(key === 'note') artifacts[i].note = input.value;
                    else if(key === 'imgCount') artifacts[i].imgCount = parseInt(input.value);
                    else artifacts[i][key] = input.value; // name, img, origin, era, desc

                    // Mark as having unsaved changes
                    hasUnsavedChanges = true;
                    updateSaveButton(true);

                    // Update gallery preview in real-time
                    updateGallery();
                });
            });

            // Manual Save Button
            const saveBtn = document.getElementById('admin-save-btn');
            saveBtn.addEventListener('click', () => {
                if (!hasUnsavedChanges) {
                    showSaveNotification(true, '‚úì No changes to save');
                    return;
                }

                const i = parseInt(select.value);
                const id = artifacts[i].id;

                // Save to JSONBin
                saveData();

                // Log to history
                saveHistory(`Saved ${id}: Manual update`);

                // Reset unsaved changes flag
                hasUnsavedChanges = false;
                updateSaveButton(false);
            });

            function updateSaveButton(hasChanges) {
                const btn = document.getElementById('admin-save-btn');
                if (hasChanges) {
                    btn.style.background = '#ff0';
                    btn.style.color = '#000';
                    btn.style.borderColor = '#ff0';
                    btn.innerHTML = '‚ö†Ô∏è SAVE CHANGES (UNSAVED)';
                } else {
                    btn.style.background = '#0a0';
                    btn.style.color = '#000';
                    btn.style.borderColor = '#0f0';
                    btn.innerHTML = 'üíæ SAVE CHANGES';
                }
            }

            fillAdminInputs();
        }

        function fillAdminInputs() {
            const art = artifacts[currentIndex];
            document.getElementById('admin-select').value = currentIndex;
            document.getElementById('admin-name').value = art.name;
            document.getElementById('admin-img').value = art.img;
            document.getElementById('admin-img-count').value = art.imgCount || 1; // New
            document.getElementById('admin-origin').value = art.origin;
            document.getElementById('admin-era').value = art.era;
            document.getElementById('admin-mat').value = art.material;
            document.getElementById('admin-cond').value = art.condition;
            document.getElementById('admin-desc').value = art.desc;
            document.getElementById('admin-note').value = art.note;
        }

        init();
    </script>
</body>
</html>
